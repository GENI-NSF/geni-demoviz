<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>GEC22 Pollution Visualization</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript">
      google.load('visualization', '1.0', {'packages':['corechart']});   
      google.setOnLoadCallback(drawVisualization);

      chart = null;
      options = {'title' : 'GEC22 Pollution Demonstration: Total Time per Server',
                 'width' : 400,
                 'height' : 300}

      label_map = {
                   "http://uvic.gee-project.net" : "UVIC",
                   "http://nicta.gee-project.net" : "NICTA"
                  };

      function addLine() {
           var newLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
           newLine.setAttribute('id', 'lineId');
           newLine.setAttribute('style', 'stroke:rgb(0,0,0); stroke-width:3;');
           newLine.setAttribute('x1', 
                chart.getChartLayoutInterface().getChartAreaBoundingBox().left);
           newLine.setAttribute('y1', chart.getChartLayoutInterface().getYLocation(150));
           newLine.setAttribute('x2',
                chart.getChartLayoutInterface().getChartAreaBoundingBox().left + 
                chart.getChartLayoutInterface().getChartAreaBoundingBox().width);
           newLine.setAttribute('y2', chart.getChartLayoutInterface().getYLocation(150));
           newLine.setAttribute('style', 'stroke:red;stroke-width:2');
           $("svg").append(newLine);
     }


      function drawVisualization() {
          if(chart == null)  {
              chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
          }

          var grab_lively_url = "grab_lively_data.php"
          $.getJSON(grab_lively_url, function(json_data) {
              var data = new google.visualization.DataTable();
              data.addColumn('string', 'Server');
              data.addColumn('number', 'Total Time');
              rows = [];
              for(var server in json_data) {
                 var total_time = json_data[server]['total_time'];
                 server = server.replace(/"/g, '');
                 var server_label = server;
                 if (server in label_map) server_label = label_map[server];
                 row = [server_label, total_time];
                 rows.push(row);
              }
              data.addRows(rows);
              chart.draw(data, options);
              setTimeout(drawVisualization, 5000);
      
          });

          var runOnce = google.visualization.events.addListener(chart, 
            'ready', function() {
             addLine();
             google.visualization.events.removeListener(runOnce);
          });

      };

    </script>
  </head>

  <body>
    <!--Div that will hold the pie chart-->
    <div id="chart_div"></div>
  </body>
</html>
